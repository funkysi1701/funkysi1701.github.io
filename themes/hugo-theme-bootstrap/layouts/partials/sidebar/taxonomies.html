{{- $order := default (slice "series" "categories" "tags") $.Site.Params.sidebarTaxonomies -}}
{{- range $expected := $order -}}
{{- range $key, $value := $.Site.Taxonomies -}}
  {{- if eq $key $expected -}}
  {{- $countPosts := default false $.Site.Params.countTaxonomyPosts -}}
  {{- $countParams := dict "categories" "categoryCount" "tags" "tagCount" "series" "seriesCount" -}}
  {{- $param := default "" (index $countParams $key) -}}
  {{- $taxonomyCount := default 20 ($.Site.Param $param) -}}
  {{- if $taxonomyCount -}}
    {{- with $value.ByCount -}}
    <section class="{{ $key }}-taxonomies row card component">
      <div class="card-header">
        <h2 class="card-title">
          <a href="{{ absLangURL (urlize $key) }}">{{ T $key }}</a>
        </h2>
      </div>
      <div class="card-body">
        <div class="py-2">
          <div class="container tagcloud">
              {{ $largestFontSize := 2.0 }}
              {{ $smallestFontSize := 0.7 }}
              {{ $fontSpread := sub $largestFontSize $smallestFontSize }}
              {{ $max := add (len (index $.Site.Taxonomies.tags.ByCount 0).Pages) 1 }}
              {{ $min := add (len (index $.Site.Taxonomies.tags.ByCount.Reverse 0).Pages) 0 }}
              {{ $spread := sub $max $min }}
              {{ $fontStep := div $fontSpread $spread }}
                {{ range $name, $taxonomy := $.Site.Taxonomies.tags.ByCount }}
                  {{ if ge .Count 2 }}
                  {{ $tagCount := len $taxonomy.Pages }}
                  {{ $currentFontSize := (add $smallestFontSize (mul (sub $tagCount $min) $fontStep) ) }}
                  {{ $weight := div (sub (math.Log $tagCount) (math.Log $min)) (sub (math.Log $max) (math.Log $min)) }}
                  {{ $currentFontSize := (add $smallestFontSize (mul (sub $largestFontSize $smallestFontSize) $weight)) }}
                    <a href="{{ "/tags/" }}{{ $name }}" 
                    class="tagcloud-item" style="font-size: {{ $currentFontSize }}rem;">
                      {{ $taxonomy.Page.Title }}
                    </a>
                    {{ end }}
                {{ end }}
          </div>
        </div>
      </div>
    </section>
    {{- end -}}
  {{- end -}}
  {{- end -}}
{{- end -}}
{{- end -}}
